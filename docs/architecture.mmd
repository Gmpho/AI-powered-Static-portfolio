graph LR
  %% Nodes
  subgraph Browser ["Browser - Vite"]
    A["Vite SPA"]
  end

  subgraph Cloudflare ["Cloudflare"]
    B["Worker"]
    K["KV Stores"]
    G["Guardrails"]
    T["Tools"]
  end

  subgraph GoogleCloud ["Google Cloud"]
    D["Gemini API"]
  end

  %% Connections
  A -->|"POST /chat (prompt, history)"| B
  A -->|"POST /api/generateEmbedding"| B
  B -->|"Enforce Rate Limits"| K
  B -->|"Apply Guardrails"| G
  G -->|"If safe, proceed"| B
  B -->|"generateContent (with tools, history)"| D
  D -->|"response (text/tool_call)"| B
  B -->|"Execute Tool (e.g., projectSearch)"| T
  T -->|"Tool Output (projects, notice)"| B
  B -->|"Cache Query Embedding"| K
  K -->|"Retrieve Project Embeddings"| T
  B -->|"Streaming SSE (text/tool_response)"| A
